<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Home">
	<select id="getAdminOrderMoney" resultType="record"
		parameterType="record">
		<![CDATA[
			select ifnull(sum(V_MONEY),0) ORDER_MONEY,ifnull(sum(CASE
				WHEN  V_PAY_TYPE = '01' THEN V_MONEY ELSE 0 end ),0) ORDER_ALI_MONEY,
			ifnull(sum(CASE
				WHEN V_PAY_TYPE = '02' THEN V_MONEY ELSE 0 end ),0) ORDER_WX_MONEY from t_order_tab  
		]]>
		<where>
			<![CDATA[
				and (V_STATUS = '1' or V_STATUS='3')
			]]>
		</where>
	</select>
	<select id="getAdminYSOrderMoney" resultType="record"
		parameterType="record">
		<![CDATA[
			select ifnull(sum(V_MONEY),0) ORDER_YS_MONEY,ifnull(sum(CASE
				WHEN  V_PAY_TYPE = '01' THEN V_MONEY ELSE 0 end ),0) ORDER_YS_ALI_MONEY,
			ifnull(sum(CASE
				WHEN V_PAY_TYPE = '02' THEN V_MONEY ELSE 0 end ),0) ORDER_YS_WX_MONEY from t_order_history  
		]]>
		<where>
			<![CDATA[
				and (V_STATUS = '1' or V_STATUS='3')  and (DATE_FORMAT(DATE_ADD(V_CREATE_TIME,INTERVAL 1 DAY),'%Y-%m-%d') = DATE_FORMAT(NOW(),'%Y-%m-%d'))
			]]>
		</where>
	</select>
	<select id="getAdminUserMoney" resultType="record"
		parameterType="record">
		<![CDATA[
			select ifnull(sum(V_COUNT_RECEIVABLES),0) USER_TOTAL_COUNT,ifnull(sum(V_SURPLUS_BOND),0) USER_TOTAL_SURPLUS,
			ifnull(sum(V_YS_RECEIVABLES),0) V_YS_RECEIVABLES 
			from t_bond_today tbt
			inner join  t_sys_user_base tsub on tbt.V_USER_ID = tsub.USER_ID 
		]]>
	</select>
	<select id="getAdminAccountMoney" resultType="record"
		parameterType="record">
		<![CDATA[
			select ifnull(sum(V_TOTAL_MONEY),0) ACCOUNT_TOTAL_COUNT from t_account_collection
		]]>
	</select>
	<select id="getAdminAppMoney" resultType="record"
		parameterType="record">
		<![CDATA[
			SELECT
			ifnull(sum(V_TOTAL_COLLECTION),0) APP_TOTAL_COUNT,ifnull(sum(V_CASH_COLLECTION),0) APP_CASH_COUNT,ifnull(sum(V_YS_COLLECTION),0) APP_YS_COUNT
		FROM
			T_COLLECTION_TAB
		]]>
	</select>
	<select id="getAdminCommisionMoney" resultType="record"
		parameterType="record">
		<![CDATA[
			SELECT
			ifnull(SUM(V_MONEY),0) COMMISSION_MONEY
		FROM
			t_commission_tab
		]]>
		<where>
			<![CDATA[
				and to_days(V_COMMISSION_TIME) = to_days(now()) and V_STATUS = '1' 
			]]>
		</where>
	</select>
	<select id="getAppMoney" resultType="record"
		parameterType="record">
		<![CDATA[
		SELECT
			ifnull(sum(V_TOTAL_COLLECTION),0) COUNT_MONEY,
			ifnull(sum(V_ALI_COLLECTION),0) ALI_MONEY,
			ifnull(sum(V_WX_COLLECTION),0) WX_MONEY,
			ifnull(sum(V_YS_COLLECTION),0) APP_YS_COUNT
		FROM
			T_COLLECTION_TAB
		]]>
		<where>
			<if test="V_APP_ID != null and V_APP_ID != ''">
				<![CDATA[
					and V_APP_ID = #{V_APP_ID}
				]]>
			</if>
		</where>
	</select>
	<select id="getAgentMoney" resultType="record"
		parameterType="record">
		<![CDATA[
		SELECT
			ifnull(V_COUNT_RECEIVABLES,0) COUNT_MONEY,
			ifnull(V_ALI_RECEIVABLES,0) ALI_MONEY,
			ifnull(V_WX_RECEIVABLES,0) WX_MONEY,
			ifnull(V_SURPLUS_BOND,0) SURPLUS_BOND,
			ifnull(V_YS_RECEIVABLES,0)V_YS_RECEIVABLES
		FROM
			t_bond_today tbt 
		]]>
		<where>
				<![CDATA[
					and tbt.V_USER_ID = #{V_USER_ID}
				]]>
		</where>
	</select>
	<select id="getOrderCount" resultType="record"
		parameterType="record">
		<![CDATA[
		SELECT
			ifnull(sum(1),0) ALL_COUNT,
			ifnull(sum(
				CASE
				WHEN V_STATUS = '1' THEN
					1
				WHEN V_STATUS = '3' THEN
					1
				END
			),0) SUCCESS_COUNT,
			ifnull(sum(CASE WHEN V_PAY_TYPE = '01' then 1 END),0) ALI_COUNT,
			ifnull(sum(
				CASE
				WHEN V_PAY_TYPE = '02' THEN
					1
				END
			),0) WX_COUNT
				FROM
				t_order_tab
		]]>
		<where>
			<if test="V_APP_ID != null and V_APP_ID != ''">
				<![CDATA[
					and V_BELONG_APP = #{V_APP_ID}
				]]>
			</if>
			<if test="V_USER_ID != null and V_USER_ID != ''">
				<![CDATA[
					and V_BELONG_USER = #{V_USER_ID}
				]]>
			</if>
		</where>
	</select>
	
	<select id="clacuOrderRate" resultType="record"
		parameterType="record">
		<![CDATA[
		SELECT TT.*,TT.success/TT.sumc RATE from (select HOUR
			( e.V_CREATE_TIME ) AS HOUR,
		SUM(
				CASE
				WHEN e.V_STATUS = 1 THEN
					1
				WHEN e.V_STATUS = 3 THEN
					1
				ELSE
					0
				END
			) success,
			SUM(
				CASE
				WHEN e.V_STATUS = 2 THEN
					1
				ELSE
					0
				END
			) fail,
			SUM(CASE
				WHEN e.V_STATUS != 0 then
					1
				ELSE
					0
				END) sumc,
		tpa.V_PAY_NAME
		FROM
			t_order_tab e LEFT JOIN t_pay_account tpa on e.V_BELONG_ACCOUNT = tpa.ID
		GROUP BY
			HOUR ( e.V_CREATE_TIME )
		ORDER BY
			HOUR ( e.V_CREATE_TIME ))TT
		]]>
	</select>
	<select id="calcuAcc" resultType="record"
		parameterType="record">
		<![CDATA[
		SELECT TT.*,SUC_SUM/COU_SUM RATE from( select 
			SUM(
				CASE
				WHEN tot.V_STATUS = 1 THEN
					1
				WHEN tot.V_STATUS = 3 THEN
					1
				ELSE
					0
				END
			) SUC_SUM,
			SUM(
				CASE
				WHEN tot.V_STATUS = 2 THEN
					1
				WHEN tot.V_STATUS = 0 THEN
					1
				ELSE
					0
				END
			) FAIL_SUM,
			SUM(1) COU_SUM,
		tpa.V_PAY_NAME,
		tsub.USER_NAME
		FROM
			t_order_tab tot 
		LEFT JOIN t_pay_account tpa on tot.V_BELONG_ACCOUNT = tpa.ID
		LEFT JOIN t_sys_user_base tsub on tot.V_BELONG_USER = tsub.USER_ID
		where tpa.V_PAY_NAME is not null
		GROUP BY
			V_BELONG_ACCOUNT )TT where SUC_SUM/COU_SUM < 0.3
		]]>
	</select>
</mapper>
